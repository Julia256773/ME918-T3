---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# ME918-T3

Este repositório contém funções de Regressão Linear simples para API e um banco de dados próprio para regressão. O conjunto de dados contém três colunas: uma correspondente à variável resposta e duas às covariáveis ("x" e "grupo", sendo esta última subdividida em três categorias: A, B e C).

## Inserir novo dado

Para inserir um novo dado, é necessário acessar o objeto "/insereDado", clicar em "Try it out" e preencher os campos das variáveis preditora (x), resposta (y) e categórica (grupo) com os respectivos valores desejados. As variáveis preditora e resposta devem ser numéricas, e a categórica deve ser no formato string. Após clicar em "Execute", a API deve retornar o banco de dados atualizado com a nova observação inserida pelo usuário, assim como a data e o horário em que a informação foi inserida.

Por exemplo, se os campos indicados forem preenchidos tal que x = 1, y = 2 e grupo = A, a API deve retornar:

[{banco de dados},{"x": 1,"grupo": "A","y": 2,"momento_registro": "2024-10-18T17:47:06Z"}]

É possível inserir um grupo que não existe previamente no conjunto de dados.



## Excluir um dado
Para excluir um dado, é necessário acessar o objeto /excluiDado, clicar em "Try it out" e preender o campo com o id da linha que deseja excluir. Este ID é referente à identificação do seu dado, não necessariamente corresponde ao número da linha no qual o dado aparece no conjunto de dados. 



## Calcular Parâmetros da Regressão

Os parâmetros da regressão linear são calculados a partir do banco de dados (já atualizado, caso um novo dado tenha sido inserido). Por isso, é necessário apenas acessar o objeto "/parametros", clicar em "Try it out" e em seguida em "Execute".  A API deve retornar uma lista no formato JSON dos valores correspondentes aos parâmetros presentes na regressão.

Por exemplo, ao calcular os parâmetros do banco de dados contido neste repositório, a API retornará com os parâmetros:

[
  {
    "nome": "(Intercept)",
    "valor": -1.4485
  },
  {
    "nome": "x",
    "valor": 0.1286
  },
  {
    "nome": "grupoB",
    "valor": 1.7128
  },
  {
    "nome": "grupoC",
    "valor": 2.8206
  },
  {
    "nome": "sigma",
    "valor": 2.3574
  }
]

## Calcular Resíduos e Valores Preditos 

Para calcular os resíduos e os valores preditos para os dados observados é necessário acessar a rota /residuosEPreditos, clicar em "Try it out" e em seguida em "Execute".  A API deve retornar um data frame no formato JSON com os valores correspondentes aos resíduos e aos valores preditos do modelo ajustado. 

Por exemplo, ao calcular os resíduos e os valores preditos para o banco de dados contido neste repositório, a API retornará







## Predição para Novos Valores

Para realizar uma predição a partir do banco de dados, é necessário abrir uma nova janela no R e ter um dataframe salvo dos valores que deseja inserir para predição. Neste dataframe deve conter uma coluna de nome "x" com os valores desejados para a variável x e uma coluna de nome "grupo" com os valores desejados para esta variável, como o exemplo abaixo:

```{r}
body = data.frame(x = c(3,4), grupo = c("A", "B"))
body
```

Após rodar a API e ter esse dataframe salvo em outra página do R, rode o seguinte comando na mesma em que tem o objeto "body":
```{r, eval = FALSE}
request("http://127.0.0.1:7593/predicaoBanco") |>
+ req_method("POST") |>
+ req_body_json(data=body, auto_unbox = TRUE) |>
+ req_perform() |>
+ resp_body_string()
```
Você terá como resposta uma lista dos valores preditos na ordem dos preditores do seu dataframe. 


## Gráfico de Regressão

Para gerar um gráfico de pontos com a reta de regressão ajustada para cada variável categórica presente no banco, é necessário acessar o objeto "/grafico". Em seguida, clique em "Try it out" e em "Execute". A API deve retornar um gráfico com os dados e as retas coloridos de acordo com os grupos aos quais pertencem, além da legenda das cores.

Por exemplo, ao gerar um gráfico a partir do banco de dados contido neste respositório e seus parâmetros, a API retornará a seguinte imagem:

```{r, echo=FALSE, include=FALSE}
library(tidyverse)
```
```{r, echo=FALSE, message=FALSE}
ra <- 256773
set.seed(ra)
b0 <- runif(1, -2, 2)
b1 <- runif(1, -2, 2)
bB <- 2
bC <- 3
n <- 25
id <- c(1:25)
x <- rpois(n, lambda = 4) + runif(n, -3, 3)
grupo <- sample(LETTERS[1:3], size = n, replace = TRUE)
y <- rnorm(n, mean = b0 + b1*x + bB*(grupo=="B") + bC*(grupo=="C"), sd = 2)
df <- data.frame(id = id, x = x, grupo = grupo, y = y,momento_registro = lubridate::now())
df %>%
    ggplot(aes(x=x, y=y, col=grupo))+
    geom_point()+
    geom_smooth(method = "lm", se=F)+
    labs(col = "Grupo")+
    theme_bw()
```

## Gráficos de Resíduos 

Para obter os gráficos de resíduos é necessário acessar a rota "/graficosResiduos", clicar em "Try it out" e em "Execute". A API deve retornar uma imagem com 6 gráficos: Valores predidos x Valores observados; QQplot dos resíduos; Valores preditos x Resíduos; Histograma dos resíduos; Número da observação x Resíduos; e Boxplot dos resíduos. 

Por exemplo, ao gerar os gráficos de resíduos a partir do banco de dados contido neste respositório, a API retornará a seguinte imagem:

```{r, echo=FALSE, message=FALSE}
modelo = lm(y~x+grupo, data=df)
residuos = summary(modelo)$residuals
preditos = modelo$fitted.values

banco = data.frame(residuos, preditos)
df_combinado = cbind(banco, df)

graf1 = ggplot(data = df_combinado, aes(x = preditos, y = y)) +
    geom_point() +
    theme_bw() +
    labs(x = "Valores Preditos", y = "Valores observados")

graf2 = ggplot(data = df_combinado, aes(sample = residuos)) +
    stat_qq(color = "black") +
    stat_qq_line(color = "blue") +
    theme_bw() +
    labs(x = "Quantis teóricos", y = "Quantis amostrais")

graf3 = ggplot(data = df_combinado, aes(x = preditos, y = residuos)) +
    geom_hline(yintercept = 0, color = "blue") +
    geom_point() +
    theme_bw() +
    labs(x = "Valores Preditos", y = "Resíduos")

graf4 = ggplot(data = df_combinado, aes(x = residuos)) +
    geom_histogram(aes(y = after_stat(density)), binwidth = 1, fill = "gray", color = "black") +
    geom_density(color = "blue", linewidth = 1) +
    theme_bw() +
    labs(y = "Densidade", x = "Resíduos")

graf5 = ggplot(data = df_combinado, aes(x = seq_along(y), y = residuos)) +
    geom_hline(yintercept = 0, color = "blue") +
    geom_point() +
    theme_bw() +
    labs(x = "Índice da observação", y = "Resíduos")

graf6 = ggplot(data = df_combinado, aes(y = residuos)) +
    geom_boxplot(fill = "gray", color = "black") +
    theme_minimal() +
    labs(y = "Resíduos") +
    theme(axis.text.x = element_blank())

graficos = ggpubr::ggarrange(graf1, graf2, graf3, graf4, graf5, graf6,
                               ncol = 2, nrow = 3)

print(graficos)
```
